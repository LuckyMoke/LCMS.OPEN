layui.define(['jquery','form'],function(exports){var MOD_NAME='selectN';var $=layui.jquery;var form=layui.form;var obj=function(config){this.selected=[];this.values=[];this.names=[];this.lastValue='';this.lastName='';this.isSelected=false;this.config={elem:'',data:[],selected:[],tips:'请选择',search:true,width:null,last:false,verify:'',filter:'',name:'',delimiter:'|',field:{idName:'id',titleName:'name',statusName:'status',childName:'children'},formFilter:null};this.config=$.extend(this.config,config);this.setTips=function(){var o=this,c=o.config;if(Object.prototype.toString.call(c.tips)!='[object Array]'){return c.tips}else{var i=$(c.elem).find('select').length;return c.tips.hasOwnProperty(i)?c.tips[i]:'请选择'}};this.setSearch=function(){var o=this,c=o.config;if(Object.prototype.toString.call(c.search)!='[object Array]'){return c.search===true?'lay-search ':' '}else{var i=$(c.elem).find('select').length;if(c.search.hasOwnProperty(i)){return c.search[i]===true?'lay-search ':' '}}return' '};this.setWidth=function(){var o=this,c=o.config;if(Object.prototype.toString.call(c.width)!='[object Array]'){return/^\d+$/.test(c.width)?'style="width:'+c.width+'px;" ':' '}else{var i=$(c.elem).find('select').length;if(c.width.hasOwnProperty(i)){return/^\d+$/.test(c.width[i])?'style="width:'+c.width[i]+'px;" ':' '}}};this.createSelect=function(optionData){var o=this,c=o.config,f=c.field;var html='';html+='<div class="layui-input-inline" '+o.setWidth()+'>';html+=' <select '+o.setSearch()+'lay-filter="'+c.filter+'">';html+='  <option value="">'+o.setTips()+'</option>';for(var i=0;i<optionData.length;i++){var disabled=optionData[i][f.statusName]==0?'disabled="" ':'';if(optionData[i][f.idName]){html+='  <option '+disabled+'value="'+optionData[i][f.idName]+'">'+optionData[i][f.titleName]+'</option>'}else{html+='  <option '+disabled+'value="'+optionData[i]['id']+'">'+optionData[i][f.titleName]+'</option>'}}html+=' </select>';html+='</div>';return html};this.getOptionData=function(catData,optionIndex){var f=this.config.field;var item=catData;for(var i=0;i<optionIndex.length;i++){if('undefined'==typeof item[optionIndex[i]]){item=null;break}else if('undefined'==typeof item[optionIndex[i]][f.childName]){item=null;break}else{item=item[optionIndex[i]][f.childName]}}return item};this.set=function(selected){var o=this,c=o.config;$E=$(c.elem);var verify=c.verify==''?'':'lay-verify="'+c.verify+'" ';var html='<div style="height:0px;width:0px;overflow:hidden"><input '+verify+'name="'+c.name+'"></div>';html+=o.createSelect(c.data);$E.html(html);selected=typeof selected=='undefined'?c.selected:selected;var index=[];for(var i=0;i<selected.length;i++){$E.find('select:last').val(selected[i]);var lastIndex=$E.find('select:last').get(0).selectedIndex-1;index.push(lastIndex);var childItem=o.getOptionData(c.data,index);if(childItem){var html=o.createSelect(childItem);$E.append(html)}};form.render('select',c.formFilter);o.getSelected()};this.change=function(elem){var o=this,c=o.config;var $thisItem=elem.parent();$thisItem.nextAll('div.layui-input-inline').remove();var index=[];$thisItem.parent().find('select').each(function(){index.push($(this).get(0).selectedIndex-1)});var childItem=o.getOptionData(c.data,index);if(childItem){var html=o.createSelect(childItem);$thisItem.after(html);form.render('select',c.formFilter)};o.getSelected()};this.getSelected=function(){var o=this,c=o.config;var values=[];var names=[];var selected=[];$E=$(c.elem);$E.find('select').each(function(){var item={};var v=$(this).val(),n=$(this).find('option:selected').text();item.value=v;item.name=n;values.push(v);names.push(n);selected.push(item)});o.selected=selected;o.values=values;o.names=names;o.lastValue=$E.find('select:last').val();o.lastName=$E.find('option:selected:last').text();o.isSelected=o.lastValue==''?false:true;var inputVal=c.last===true?o.lastValue:o.values.join(c.delimiter);$E.find('input[name="'+c.name+'"]').val(inputVal)};this.getData=function(url){var d;$.ajax({url:url,dataType:'json',async:false,success:function(json){d=json},error:function(){console.error(MOD_NAME+' hint：候选数据ajax请求错误 ');d=false}});return d}};obj.prototype.render=function(){var o=this,c=o.config;$E=$(c.elem);if($E.length==0){console.error(MOD_NAME+' hint：找不到容器 '+c.elem);return false};if(Object.prototype.toString.call(c.data)!='[object Array]'){var data=o.getData(c.data);if(data===false){console.error(MOD_NAME+' hint：缺少分类数据');return false};o.config.data=data};c.filter=c.filter==''?c.elem.replace('#','').replace('.',''):c.filter;c.name=c.name==''?c.elem.replace('#','').replace('.',''):c.name;o.config=c;o.set();form.on('select('+c.filter+')',function(data){o.change($(data.elem))});$E.find('input[name="'+c.name+'"]').focus(function(){var t=$(c.elem).offset().top;$('html,body').scrollTop(t-200);$(c.elem).find('select:last').addClass('layui-form-danger');setTimeout(function(){$(c.elem).find('select:last').removeClass('layui-form-danger')},3000)})};exports(MOD_NAME,function(config){var _this=new obj(config);_this.render();return _this})});