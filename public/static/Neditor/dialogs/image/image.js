(function(){var remoteImage;window.onload=function(){initTabs();initAlign();initButtons()};function initTabs(){parent.window.LCMSEDITORNOW=editor;var tabs=$G("tabhead").children;for(var i=0;i<tabs.length;i++){domUtils.on(tabs[i],"click",function(e){var target=e.target||e.srcElement;switch(target.getAttribute("data-content-id")){case"upload":parent.LCMS.util.iframe({title:"上传图片",url:"index.php?t=sys&n=upload&c=gallery&a=upload&many=1",shade:true,area:["550px","550px"]});dialog.close();break;case"gallery":parent.LCMS.util.iframe({title:"图库",url:"index.php?t=sys&n=upload&c=gallery&many=1&id=LCMSEDITOR",shade:true,area:["550px","550px"]});dialog.close();break}})}setTabFocus("remote")}function setTabFocus(id){if(!id)return;var i,bodyId,tabs=$G("tabhead").children;for(i=0;i<tabs.length;i++){bodyId=tabs[i].getAttribute("data-content-id");if(bodyId==id){domUtils.addClass(tabs[i],"focus");domUtils.addClass($G(bodyId),"focus")}else{domUtils.removeClasses(tabs[i],"focus");domUtils.removeClasses($G(bodyId),"focus")}}switch(id){case"remote":remoteImage=remoteImage||new RemoteImage();break}}function initButtons(){dialog.onok=function(){var remote=false,list=[],id,tabs=$G("tabhead").children;for(var i=0;i<tabs.length;i++){if(domUtils.hasClass(tabs[i],"focus")){id=tabs[i].getAttribute("data-content-id");break}}switch(id){case"remote":list=remoteImage.getInsertList();break}if(list){editor.execCommand("insertimage",list);remote&&editor.fireEvent("catchRemoteImage")}}}function initAlign(){domUtils.on($G("alignIcon"),"click",function(e){var target=e.target||e.srcElement;if(target.className&&target.className.indexOf("-align")!=-1){setAlign(target.getAttribute("data-align"))}})}function setAlign(align){align=align||"none";var aligns=$G("alignIcon").children;for(i=0;i<aligns.length;i++){if(aligns[i].getAttribute("data-align")==align){domUtils.addClass(aligns[i],"focus");$G("align").value=aligns[i].getAttribute("data-align")}else{domUtils.removeClasses(aligns[i],"focus")}}}function getAlign(){var align=$G("align").value||"none";return align=="none"?"":align}function RemoteImage(target){this.container=utils.isString(target)?document.getElementById(target):target;this.init()}RemoteImage.prototype={init:function(){this.initContainer();this.initEvents()},initContainer:function(){this.dom={url:$G("url"),width:$G("width"),height:$G("height"),border:$G("border"),vhSpace:$G("vhSpace"),title:$G("title"),align:$G("align")};var img=editor.selection.getRange().getClosedNode();if(img){this.setImage(img)}},initEvents:function(){var _this=this;domUtils.on($G("url"),"keyup",updatePreview);domUtils.on($G("border"),"keyup",updatePreview);domUtils.on($G("title"),"keyup",updatePreview);function updatePreview(){_this.setPreview()}},setImage:function(img){if(!img.tagName||(img.tagName.toLowerCase()!="img"&&!img.getAttribute("src"))||!img.src)return;var wordImgFlag=img.getAttribute("word_img"),src=wordImgFlag?wordImgFlag.replace("&amp;","&"):img.getAttribute("_src")||img.getAttribute("src",2).replace("&amp;","&"),align=editor.queryCommandValue("imageFloat");if(src!==$G("url").value)$G("url").value=src;if(src){$G("width").value=img.getAttribute("width")||img.width;$G("height").value=img.getAttribute("height")||img.height;$G("border").value=img.getAttribute("border")||"0";$G("vhSpace").value=img.getAttribute("vspace")||"0";$G("title").value=img.title||img.alt||"";setAlign(align);this.setPreview()}},getData:function(){var data={};for(var k in this.dom){data[k]=this.dom[k].value}return data},setPreview:function(){var url=$G("url").value,border=$G("border").value,title=$G("title").value,preview=$G("preview");if(url){if(url.indexOf("../upload/")!==-1){url=url.replace(/../,"")}preview.innerHTML='<img src="'+url+'" border="'+border+'px solid #000" title="'+title+'" />'}},getInsertList:function(){var data=this.getData();if(data["width"].indexOf("%")===-1){data["width"]=data["width"]+"px"}if(data["height"]!=="auto"){data["height"]=data["height"]+"px"}if(data["url"]){return[{src:data["url"],_src:data["url"],width:data["width"].replace(/px/,"")||"",height:data["height"].replace(/px/,"")||"",border:data["border"]||"",floatStyle:data["align"]||"",vspace:data["vhSpace"]||"",alt:data["title"]||"",style:"width:"+data["width"]+";height:"+data["height"]}]}else{return[]}},}})();