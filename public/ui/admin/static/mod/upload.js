let uiImageTpl='<div class="_li"><a href="{src}" target="_blank"><img class="layui-upload-img lazyload" data-lazy="{src}" data-original="{original}"/></a><div class="_icon"><div class="_del"><i class="layui-icon layui-icon-close"></i></div></div></div>',uiImageLazy=function(){LCMS.util.lazyImg("lazyload",{datasrc:"data-lazy"})},uiImageSetValue=function(arr={}){let list=[];return(arr.each(function(){list.push($(this).attr("data-original"))}),list.join("|"))},uiImageRemove=function(id,index){let _this=$("#"+id);if(typeof index=="number"){_this.children("._li").eq(index).remove()}else{_this.html("")}_this.parent("div").siblings("input").val(uiImageSetValue(_this.find("img")))},uiImageUpload=function(_this,files,index,callback){let file=files[index],input=_this.children("input"),local=input.attr("local"),multiple=input.attr("multiple"),gid=_this.parent(".lcms-form-upload-btn").attr("data-id"),data=_this.data(),that=$("#"+gid),tpl='<input type="file"'+("1"==data.many?' multiple="multiple"':"")+' accept="'+(data.accept||"image/*")+'" local="'+data.local+'" name="_lcmsfileinput" style="position:absolute;left:0;top:0;width:100%;height:100%;opacity:0;cursor:pointer;font-size:0;">',isurl=false;if(typeof file=="string"&&file.indexOf("://")!=-1){isurl=true}if(null!=file){_this.children("._loading").css("display","inline-block");let startUpload=function(){LCMS.plugin.upload.direct({type:isurl?"url":"image",file:file,local:local>0?1:0,success:function(res){LCMS.util.notify({content:res.msg});that[multiple=="multiple"?"append":"html"](LCMS.util.tpl(uiImageTpl,{src:res.data.src,original:res.data.original}));setTimeout(()=>{uiImageLazy();that.parent(".layui-input-block").siblings("input").val(uiImageSetValue(that.find("img")));callback&&callback(res.data)},500)},complete:function(){_this.children("._loading").hide();input.remove();_this.append(tpl);uiImageUpload(_this,files,index+1,callback)},})};if(isurl||file.type=="image/svg+xml"){startUpload()}else{let tmpimage=new Image();tmpimage.src=window.URL.createObjectURL(new Blob([file]));tmpimage.onload=function(){setTimeout(function(){if(data.maxwidth||data.maxheight){if(tmpimage.width>data.maxwidth||tmpimage.height>data.maxheight){LCMS.util.notify({type:"error",title:"上传失败",content:"图片尺寸超过限制，请按照说明选择合适尺寸的图片上传"});_this.children("._loading").hide();input.remove();_this.append(tpl);callback&&callback({});uiImageUpload(_this,files,index+1,callback);return}}startUpload()},1)}}}},uiImageDataToFile=function(dataurl){let arr=dataurl.split(","),mime=arr[0].match(/:(.*?);/)[1],bstr=atob(arr[1]),n=bstr.length,u8arr=new Uint8Array(n);while(n--){u8arr[n]=bstr.charCodeAt(n)}return new File([u8arr],"image.jpg",{type:mime,lastModified:Date.now()})};LCMS.plugin.upload.add=function(id,files,callback){let _this=$("#"+id).siblings(".lcms-form-upload-btn").children("._up");if(!(files instanceof Blob||files instanceof File)){files=uiImageDataToFile(files)}if(files&&!files[0]){files=[files]}uiImageUpload(_this,files,0,callback)};LCMS.plugin.upload.remove=function(id,index){uiImageRemove(id,index)};$(".lcms-form-upload-img-list").on("click","div._del",function(e){let id=$(e.delegateTarget).attr("id"),li=$($(this).parentsUntil(".lcms-form-upload-img-list")[1]),index=li.index();uiImageRemove(id,index)});let listenImgList=new MutationObserver(function(mutations){mutations.forEach(function(mutation){if(mutation.type==="childList"){if(mutation.addedNodes.length>0){let _this=$(mutation.target),_li=_this.find("._li"),data=_this.siblings(".lcms-form-upload-btn").find("._up").data();(data.maxwidth||data.maxheight)&&_this.find("img").each(function(){$(this).on("load",function(){if(this.naturalWidth>data.maxwidth||this.naturalHeight>data.maxheight){_li.remove();_this.parent("div").siblings("input").val(uiImageSetValue(_this.find("img")));LCMS.util.notify({type:"error",title:"选择失败",content:"图片尺寸超过限制，请按照说明选择合适尺寸的图片"})}})})}}})});$(".lcms-form-upload-img-list").each(function(index,element){listenImgList.observe(element,{childList:true,attributes:false,subtree:false})});$(".lcms-form-upload-img").each(function(){top.LCMSUIINDEX++;let that=$(this),id="LCMSUPLOADSORTABLE"+top.LCMSUIINDEX,list=that.children("input").val().split("|"),box=that.find(".lcms-form-upload-img-list"),force=that.find("a._up").attr("data-local");box.attr("id",id);that.find(".lcms-form-upload-btn").attr("data-id",id);for(let i=0;i<list.length;i++){if(list[i]){let src=list[i];if(force!=1&&"local"!=LCMS.config.oss&&-1==src.indexOf("://")&&-1!=src.indexOf("../upload/")){src=LCMS.config.cdn+src.replace("../","")}box.append(LCMS.util.tpl(uiImageTpl,{src:src,original:list[i]}))}}uiImageLazy();Sortable.create(document.getElementById(id),{filter:"._del",onUpdate:function(evt){let id=evt.srcElement.id;$("#"+id).parent(".layui-input-block").siblings("input").val(uiImageSetValue($("#"+id).find("img")))},})});$(".lcms-form-upload-btn ._box").on("click",function(){let many=$(this).attr("data-many"),id=$(this).parent(".lcms-form-upload-btn").attr("data-id");LCMS.util.iframe({title:"图库",url:LCMS.url.own+"t=sys&n=upload&c=gallery&many="+many+"&id="+id,shade:true,area:["550px","550px"]})});$(".lcms-form-upload-btn ._up").on("click",function(){layer.close(layer.index)});$(".lcms-form-upload-btn ._up").each(function(){top.LCMSUIINDEX++;let _this=$(this),id="LCMSUPLOADBTN"+top.LCMSUIINDEX,gid=_this.parent(".lcms-form-upload-btn").attr("data-id"),data=_this.data(),that=$("#"+gid);_this.attr("id",id),_this.append('<input type="file"'+("1"==data.many?' multiple="multiple"':"")+' accept="'+(data.accept||"image/*")+'" local="'+data.local+'" name="_lcmsfileinput" style="position:absolute;left:0;top:0;width:100%;height:100%;opacity:0;cursor:pointer;font-size:0;">');_this.on("click","input",function(){$(this).off("change").on("change",function(){uiImageUpload(_this,this.files,0)})});_this.siblings("._other").on("click",function(){let pindex=layer.prompt({title:"支持以下方式粘贴图片",formType:2},function(file){layer.close(pindex);uiImageUpload(_this,[file],0)}),textArea=$("#layui-layer"+pindex).find("textarea");textArea.attr("placeholder","1、输入图片链接地址\n2、粘贴网页里复制的一张图\n3、粘贴QQ、微信等软件截图或一张聊天图\n4、粘贴电脑文件夹里复制的多张图\n5、粘贴WORD文档里复制的一张图");textArea.bind("paste",function(e){if(e.originalEvent.clipboardData&&e.originalEvent.clipboardData.items){let files=[];for(let i=0;i<e.originalEvent.clipboardData.items.length;i++){let item=e.originalEvent.clipboardData.items[i];if("file"==item.kind&&-1!==item.type.indexOf("image/")){let file=item.getAsFile();if(0===file.size){LCMS.util.notify({type:"error",content:"文件获取失败"})}else{files.push(file)}}}if(files.length>0){uiImageUpload(_this,files,0);textArea.unbind("paste");layer.close(pindex)}}})})});