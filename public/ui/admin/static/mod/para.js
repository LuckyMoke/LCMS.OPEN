$(".lcms-form-para").each((function(){top.LCMSUIINDEX++;const id=`LCMSFORMPARA${top.LCMSUIINDEX}`;$(this).attr("id",id).show();LCMS.util.tplx(id,{name:"",iscache:false,config:{},form:[],previews:[],init(){if(this.$el.dataset.config){this.config=JSON.parse($.base64.decode(this.$el.dataset.config));if(!this.config.btn){this.config.btn="添加一个"}}if(this.config.cache){this.config.cache="lcms-form-para-"+$.base64.encode(this.config.cache,true)}if(this.$el.dataset.value){this.form=JSON.parse($.base64.decode(this.$el.dataset.value))}else{this.iscache=this.getCache()?true:false}this.name=this.$el.dataset.name;for(let i=0;i<this.form.length;i++){this.previews[i]={}}for(let i=0;i<this.config.cols.length;i++){const col=this.config.cols[i];switch(col.type){case"image":col.input_type="text";for(let ii=0;ii<this.form.length;ii++){const f=this.form[ii];this.setPreview(ii,col.name,this.getImage(f[col.name]))}break;case"choose":col.input_type="text";if(col.onpreview){for(let ii=0;ii<this.form.length;ii++){const f=this.form[ii];this.setPreview(ii,col.name,LCMS.util.getFun(col.onpreview)(f[col.name]))}}break;case"input":col.input_type="text";break;default:col.input_type=col.type;break}}this.sortTr()},sortTr(){Sortable.create(this.$refs.paralist,{draggable:"tr",handle:".lcms-form-para-handle",onTplx:func=>{LCMS.util.tplx("change:dom",func)},onUpdate:e=>{const[...form]=this.form;const[...previews]=this.previews;const f=form.splice(e.oldIndex,1)[0];form.splice(e.newIndex,0,f);const p=previews.splice(e.oldIndex,1)[0];previews.splice(e.newIndex,0,p);this.form=[];this.previews=[];setTimeout((()=>{this.form=form;this.previews=previews}))},onStart:()=>{scrollTop=document.documentElement.scrollTop||document.body.scrollTop},onEnd:()=>{setTimeout((()=>{document.documentElement.scrollTop=document.body.scrollTop=scrollTop}))}})},openGallery(col,tridx){LCMS.plugin.upload.gallery((list=>{this.setPreview(tridx,col.name,list[0].src);this.setForm(tridx,col.name,list[0].original)}),0)},onChoose(col,tridx){if(col.onclick){LCMS.util.getFun(col.onclick)(col,tridx,this)}},onAdd(data){let form={};for(let i=0;i<this.config.cols.length;i++){const col=this.config.cols[i];form[col.name]=data[i]||col.default||""}this.form.push(form);this.previews.push({})},onBatch(){layer.prompt({title:"每行一个条，内容用 | 分隔",formType:2,maxlength:2000,value:this.config.batch},((paras,layidx)=>{paras=paras.replace(/\r\n/g,"\n");paras=paras.split("\n");for(let i=0;i<paras.length;i++){let para=paras[i];if(para){para=para.split("|");if(para[0]){this.onAdd(para)}}}this.setCache();layer.close(layidx)}))},onDel(tridx){layer.alert("确认删除？",{btn:"确认",yes:layidx=>{layer.close(layidx);this.form.splice(tridx,1);this.previews.splice(tridx,1);this.setCache()}})},onDelAll(){layer.alert("确认删除全部？",{btn:"确认",yes:layidx=>{layer.close(layidx);this.form=[];this.previews=[]}})},onInput(col,tridx){this.setCache()},onInputClick(col,tridx){switch(col.type){case"checkbox":this.setForm(tridx,col.name,this.form[tridx][col.name]>0?0:1);break}},getCache(){if(this.config.cache){let form=localStorage.getItem(this.config.cache);form=form?JSON.parse(form):null;return form&&form[0]?form:null}return null},setCache(){if(!this.config.cache){return}let[...form]=this.form;form=JSON.stringify(form);localStorage.setItem(this.config.cache,form);this.iscache=false},useCache(){this.iscache=false;this.form=this.getCache()},showCache(){let cache=this.getCache();if(cache){this.form=cache}},setForm(index,name,value){this.form[index][name]=value},setPreview(index,name,value){this.previews[index][name]=value},getImage(src){if("local"!=LCMS.config.oss){return LCMS.config.cdn+src.replace("../","")}return src}})}));