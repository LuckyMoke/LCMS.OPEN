let mark2html=function(content){let html="";if(content&&"undefined"!=typeof marked){html=marked.parse(content,{breaks:true,mangle:false,headerIds:false});html=html.replace(/<pre><code/gi,"<pre").replace(/<\/code><\/pre>/gi,"</pre>")}return html?html:""};$("body").append(`<style>.edui-for-aiwrite{display:block}div.edui-box.edui-for-aiwrite{display:inline-block!important}</style>`);LCMS.plugin.aimodel={index:null,apicfg:null,options:{},request:null,chat:null};LCMS.plugin.aimodel.chat=function(opts){if(!this.request){const lindex=LCMS.util.loading();LCMS.util.load({type:"js",src:`${LCMS.url.static}plugin/marked.min.js`});LCMS.util.ajax({type:"GET",url:`${LCMS.url.own}t=sys&n=aimodel&a=config`,async:false,layer:true,success:function(res){if(1==res.code){LCMS.plugin.aimodel.apicfg=res.data}else{LCMS.util.notify({type:"error",content:"API配置信息获取失败"});return false}}});LCMS.util.load({type:"js",src:`${LCMS.url.app}sys/aimodel/include/resource/libs/${LCMS.config.aichat}.js`,async:false});LCMS.util.loading("close",lindex)}opts=Object.assign({model:LCMS.config.aichat,window:false,system:"",messages:[]},opts||{});if(opts.messages.length>5){opts.messages=opts.messages.slice(-5)}this.options=opts;if(opts.window){let openWin=()=>{let laydata={id:"lcms-aimodel-chat-window",title:opts.window,url:`${LCMS.url.own}t=sys&n=aimodel`,area:opts.area?opts.area:["500px","500px"],cancel:()=>{this.index=null}};if(opts.slide){laydata=Object.assign(laydata,{area:[$(window).width()<=400?"100%":"400px","100%"],offset:"r",anim:"slideLeft",hideOnClose:true})}this.index=LCMS.util.iframe(laydata)};if(this.index){layer.close(this.index,(()=>{openWin()}))}else{openWin()}}else{if(0==opts.messages.length){return false}let def=Object.assign({},opts),content="",html="";delete def.onmessage;delete def.onclose;delete def.onerror;this.request(Object.assign({},def,{onmessage:function(txt,other){if(txt){content+=txt;if(-1!==txt.indexOf("\n")){html=mark2html(content)}opts.onmessage&&opts.onmessage(txt,html,other)}},onclose:function(other){if(content||other){html=mark2html(content);opts.onclose&&opts.onclose(content,html,other)}},onerror:function(error){opts.onerror&&opts.onerror(error)}}))}};let selectIdx=null;$("#LCONTENT .lcms-form-input, #LCONTENT .lcms-form-textarea textarea").on("contextmenu",(function(event){selectIdx&&layer.close(selectIdx);selectIdx=null;const text=window.getSelection().toString();if(""==text||text.length<=0){return}event.preventDefault();let inputThis=$(this),cursorPos=inputThis.prop("selectionStart"),textBefore=inputThis.val().substring(0,cursorPos),textAfter=inputThis.val().substring(cursorPos+text.length,inputThis.val().length);const insertAtCursor=function(newText){inputThis.val(textBefore+newText+textAfter);cursorPos+=newText.length;inputThis.prop("selectionStart",cursorPos);inputThis.prop("selectionEnd",cursorPos)},startChat=function(content){LCMS.plugin.aimodel.chat({window:"AI助手",welcome:"Hi！我的你的AI助手，有什么需要可直接问我。",system:"请在回答中直接给出内容，不要添加任何多余的修饰词和你的语气词。",content:`${content}\n${text}`,chatbtns:[{title:"插入原位置",tips:"将内容插入到原输入框位置",onclick:function(chatFunc,chat){insertAtCursor(chat.content)}}]})};selectIdx=layer.tips(`<div class="lcms-tips-btns"><span class="lcms-tips-btn" data-type="copy">复制</span><span class="lcms-tips-btn" data-type="fanyi">翻译</span><span class="lcms-tips-btn" data-type="youhua">优化</span><span class="lcms-tips-btn layui-icon layui-icon-close" data-type="close"></span></div>`,this,{time:5000,tips:3,success:function(layero){layero.find(".lcms-tips-btn").on("click",(function(){layer.close(selectIdx);const type=$(this).attr("data-type");switch(type){case"fanyi":layer.prompt({title:"翻译成哪种语言？",formType:0,placeholder:"请输入语言，例如：英语"},(function(lang,idx){if(lang){startChat(`请将以下内容翻译成${lang}。`);layer.close(idx)}else{LCMS.util.notify({type:"error",content:"请输入语言名称"})}}));break;case"youhua":startChat("请将以下内容进行润色优化。");break;case"copy":LCMS.util.copy(text);break;case"close":break}}))}})}));