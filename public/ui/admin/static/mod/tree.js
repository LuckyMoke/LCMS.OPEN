layui.extend({treeGrid:"treeGrid/treeGrid"}).use(["treeGrid"],function(){let lcmsTreeAjaxAct=function(tableId,Act,defAct){switch(Act){case"close":let tables=$("table.lcms-table",parent.document),trees=$("table.lcms-table-tree",parent.document);if(tables.length>0||trees.length>0){tables.each(function(){parent.layui.table.reloadData($(this).attr("id"))});trees.each(function(){parent.layui.treeGrid.query($(this).attr("id"))});LCMS.util.iframe({do:"close"})}else{LCMS.util.iframe({do:"close",reload:true})}break;case"reload":setTimeout(function(){layui.treeGrid.query(tableId)},1000);break;case"reload-page":setTimeout(function(){window.location.reload()},1000);break;case"reload-parent":setTimeout(function(){parent.window.location.reload()},1000);break;case"reload-top":setTimeout(function(){top.window.location.reload()},1000);break;case"goback":setTimeout(function(){window.location.href=document.referrer},1000);break;default:defAct&&setTimeout(function(){defAct()},1000);break}},lcmsTreeAjax=function(tableId,url,arr){LCMS.util.ajax({type:"POST",url:url,data:{LC:arr},success:function(res){if(res.code==1){LCMS.util.notify({content:res.msg});lcmsTreeAjaxAct(tableId,res.go)}else if(res.code==2){LCMS.util.notify({content:res.msg});setTimeout(function(){try{eval(res.go)(res.data)}catch(error){}},res.msg?1000:1)}else{LCMS.util.notify({type:"error",content:res.msg})}},})};$(".lcms-table-tree-box").each(function(index){top.LCMSUIINDEX++;let _this=$(this),cols=[],tableId="LCMSTABLETREE"+top.LCMSUIINDEX,table=_this.children(".lcms-table-tree"),openall=_this.children(".lcms-table-tree-openall"),form=_this.children("form"),data=JSON.parse(table.attr("data"));table.attr("id",tableId);openall.attr("data-id",tableId);data.id&&_this.attr("id",data.id);cols[0]={type:"checkbox",sort:true};for(let i=1;i<=data.cols.length;i++){let myindex=i-1;if(data.cols[myindex].toolbar){cols[i]={title:data.cols[myindex].title,templet:function(){return data.cols[myindex].toolbar},}}else{cols[i]=data.cols[myindex]}}let treeId=data.top?data.top.split("|"):[];layui.treeGrid.render({id:tableId,elem:"#"+tableId,idField:"id",url:data.url+"&page=1&limit=1000",treeId:treeId[1]?treeId[0]:"id",treeUpId:data.top?(treeId[1]?treeId[1]:data.top):"top_id",treeShowName:data.show?data.show:"title",isOpenDefault:true,branch:["",""],leaf:"&#xe621;&nbsp;",even:true,cols:[cols],page:false});layui.treeGrid.on("tool("+tableId+")",function(obj){let data=$(this).data();data.url=data.url?data.url.replace(/{id}/g,obj.data.id):"";switch(obj.event){case"ajax":if(data.tips){layer.alert(data.tips,{area:"120px"},function(){lcmsTreeAjax(tableId,data.url,obj.data)})}else{lcmsTreeAjax(tableId,data.url,obj.data)}break;case"iframe":let area=null;if(data.area){area=data.area.split(",");if(area.length<2){area=area[0]}}LCMS.util.iframe({title:$(this).attr("data-title"),url:data.url+"&id="+obj.data.id,area:area});break;case"href":window.location.href=data.url+"&id="+obj.data.id;break;case"switch":let elm=$(this).prev("input");let url=elm.attr("data-url");url=url?url.replace(/{id}/g,obj.data.id):"";if(url.length>0){LCMS.util.ajax({type:"POST",url:url,data:{LC:{id:LCMS.util.getQuery("id",url),name:LCMS.util.getQuery("name",url),value:elm.is(":checked")?"1":"0"}},success:function(res){if(res.code==1){LCMS.util.notify({content:res.msg});lcmsTreeAjaxAct(tableId,res.go,function(){if(res.go){window.location.href=res.go}})}else if(res.code==2){LCMS.util.notify({content:res.msg});elm.prop("checked",elm.is(":checked")?false:true);layui.form.render("checkbox");setTimeout(function(){try{eval(res.go)(res.data)}catch(error){}},res.msg?1000:1)}else{LCMS.util.notify({type:"error",content:res.msg});elm.prop("checked",elm.is(":checked")?false:true);layui.form.render("checkbox")}},})}break}});layui.treeGrid.on("edit("+tableId+")",function(obj){LCMS.util.ajax({type:"POST",url:data.url+"-save",data:{LC:{id:obj.data.id,name:obj.field,value:obj.value}},success:function(res){if(res.code==1){LCMS.util.notify({content:res.msg})}else{LCMS.util.notify({type:"error",content:res.msg})}},})});openall.on("click",function(){let id=$(this).attr("data-id"),treedata=layui.treeGrid.getDataList(id),isOpen=treedata[0]?treedata[0][layui.treeGrid.config.cols.isOpen]:false;layui.treeGrid.treeOpenAll(id,!isOpen)});_this.children("button").on("click",function(){let event=$(this).attr("lay-event");let data=$(this).data();switch(event){case"ajax":let checkStatus=layui.treeGrid.checkStatus(tableId);if(data.tips){layer.alert(data.tips,{area:"120px"},function(){lcmsTreeAjax(tableId,data.url,checkStatus.data)})}else{lcmsTreeAjax(tableId,data.url,checkStatus.data)}break;case"iframe":let area=null;if(data.area){area=data.area.split(",");if(area.length<2){area=area[0]}}LCMS.util.iframe({title:$(this).attr("data-title"),url:data.url,area:area});break;case"href":window.location.href=data.url;break}})})});$(".lcms-table-tree-box").on({mouseenter:function(){if($(this).children("i.layui-icon").length>0){let title=$(this).attr("data-title");title&&layer.tips(title,$(this),{tips:[1,"#303133"],time:0})}},mouseleave:function(){layer.closeAll("tips")},},"button");