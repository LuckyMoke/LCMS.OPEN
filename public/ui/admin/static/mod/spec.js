$(".lcms-form-spec").each((function(){top.LCMSUIINDEX++;const id=`LCMSFORMSPEC${top.LCMSUIINDEX}`;$(this).attr("id",id);LCMS.util.tplx(id,{id:id,loading:false,name:"",max:5,maxattr:20,fields:[],specData:{spec:[],data:{}},skus:[],tables:[],init(){if(this.$el.dataset.value){const specData=JSON.parse($.base64.decode(this.$el.dataset.value));if(specData.spec){this.specData={spec:specData.spec,data:specData.data||{}}}}if(this.$el.dataset.fields){this.fields=JSON.parse($.base64.decode(this.$el.dataset.fields))}if(this.$el.dataset.max){this.max=parseInt(this.$el.dataset.max)}if(this.$el.dataset.maxattr){this.maxattr=parseInt(this.$el.dataset.maxattr)}this.name=this.$el.dataset.name;this.sortTr();this.getTables(true)},sortTr(){Sortable.create(this.$refs.speclist,{draggable:"tr",handle:".lcms-form-spec-trhandle",onTplx:func=>{LCMS.util.tplx("change:dom",func)},onUpdate:e=>{const[...list]=this.specData.spec;const item=list.splice(e.oldIndex,1)[0];list.splice(e.newIndex,0,item);this.specData.spec=[];setTimeout((()=>{this.specData.spec=list;this.sortTr()}))},onStart:()=>{scrollTop=document.documentElement.scrollTop||document.body.scrollTop},onEnd:()=>{setTimeout((()=>{this.getTables();document.documentElement.scrollTop=document.body.scrollTop=scrollTop}))}});this.sortTd()},sortTd(idx){const sort=(el,idx)=>{Sortable.create(el,{draggable:"span",onTplx:func=>{LCMS.util.tplx("change:dom",func)},onUpdate:e=>{const oidx=e.oldIndex;const nidx=e.newIndex;const[...list]=this.specData.spec[idx].list;const item=list.splice(oidx,1)[0];list.splice(nidx,0,item);this.specData.spec[idx].list=[];this.holdData(oidx,nidx);setTimeout((()=>{this.specData.spec[idx].list=list}))},onStart:()=>{scrollTop=document.documentElement.scrollTop||document.body.scrollTop},onEnd:()=>{setTimeout((()=>{this.getTables();document.documentElement.scrollTop=document.body.scrollTop=scrollTop}))}})};setTimeout((()=>{if("undefined"!=typeof idx){sort($(`#${this.id} .lcms-form-spec-td`)[idx],idx)}else{$(`#${this.id} .lcms-form-spec-td`).each(((idx,el)=>{sort(el,idx)}))}}))},getInput(field,tridx){let html="";const sku=this.skus[tridx];const name=`${this.name}[data][${sku}][${field.name}]`;let value;if(this.specData.data[sku]&&this.specData.data[sku][field.name]){value=this.specData.data[sku][field.name]}switch(field.type){case"image":html=`<input type="hidden" class='layui-input' name="${name}" value="${value||""}" /><img src="${value||"/public/static/images/icons/upload.svg"}" @click="openGallery(field,tridx)" />`;break;default:html=`<input type="${field.type||"text"}" class='layui-input' name="${name}" value="${value||field.default}" @blur="updateInput(field,tridx)" />`;break}return html},updateInput(field,tridx,value){if(1==this.specData.spec.length){const sku=this.skus[tridx];this.specData.data[sku][field.name]=value||this.$el.value}},allInput(field){layer.prompt({title:"批量填写此列内容",value:""},((value,index,elem)=>{value=value.trim();if(""===value){return elem.focus()}layer.close(index);const{...datas}=this.specData.data;Object.keys(datas).forEach((sku=>{datas[sku]={...datas[sku]};datas[sku][field.name]=value}));this.specData.data=datas}))},holdData(oidx,nidx){if(1==this.specData.spec.length){let ndatas={};const datas=this.specData.data;const odata=datas[`0_${oidx}`];const ndata=datas[`0_${nidx}`];Object.keys(datas).forEach(((key,index)=>{if(index>oidx&&index<=nidx){ndatas[`0_${index-1}`]={...datas[key]}}else if(index<oidx&&index>=nidx){ndatas[`0_${index+1}`]={...datas[key]}}else if(index==oidx){ndatas[`0_${nidx}`]={...odata}}else if(index==nidx){ndatas[`0_${oidx}`]={...ndata}}else{ndatas[key]={...datas[key]}}}));ndatas=Object.keys(ndatas).sort().reduce(((r,k)=>(r[k]=ndatas[k],r)),{});this.specData.data=ndatas}},openGallery(field,tridx){const sku=this.skus[tridx];const name=`${this.name}[data][${sku}][${field.name}]`;LCMS.plugin.upload.gallery((list=>{LCMS.util.tplx("change:dom",(()=>{const elm=$(`[name="${name}"]`);elm.val(list[0].original);elm.next("img").attr("src",list[0].src);this.updateInput(field,tridx,list[0].original)}))}),0)},openLayer(callback,value){layer.prompt({title:"请输入",value:value||"",placeholder:"名称"},((value,index,elem)=>{value=value.trim();if(""===value){return elem.focus()}layer.close(index);callback(value)}))},specAdd(){if(this.specData.spec.length>=this.max){LCMS.util.notify({type:"error",content:`最多只能添加${this.max}个规格`});return}this.openLayer((value=>{let cango=true;this.specData.spec.forEach((item=>{if(item.title===value){LCMS.util.notify({type:"error",content:"该规格已经存在"});cango=false;return}}));cango&&this.specData.spec.push({title:value,list:[]})}))},specDel(tridx){this.specData.spec.splice(tridx,1);this.getTables()},specChange(tridx){this.openLayer((value=>{this.specData.spec[tridx].title=value;this.sortTd(tridx);this.getTables()}),this.specData.spec[tridx].title)},specClear(){this.specData.spec=[];this.specData.data={};this.getTables()},specAdd2(tridx){if(this.specData.spec[tridx].list.length>=this.maxattr){LCMS.util.notify({type:"error",content:`最多只能添加${this.maxattr}个属性`});return}this.openLayer((value=>{let cango=true;this.specData.spec[tridx].list.forEach((item=>{if(item.title===value){LCMS.util.notify({type:"error",content:"该属性已经存在"});cango=false;return}}));if(cango){this.specData.spec[tridx].list.push({title:value});this.sortTd(tridx);this.getTables()}}))},specDel2(tridx,tdidx){this.specData.spec[tridx].list.splice(tdidx,1);if(0===this.specData.spec[tridx].list.length){this.specDel(tridx)}this.getTables()},specChange2(tridx,tdidx){this.openLayer((value=>{this.specData.spec[tridx].list[tdidx].title=value;this.sortTd(tridx);this.getTables()}),this.specData.spec[tridx].list[tdidx].title)},getTables(first){const[...specs]=this.specData.spec;if(0===specs.length){this.tables=[];return}const getList=(data,tridx)=>{tridx=tridx||0;if(0===data.length){return[[]]}const group=data[0];const regroup=data.slice(1);const relist=getList(regroup,tridx+1);const list=[];group.list.forEach(((item,tdidx)=>{relist.forEach((redata=>{list.push([{title:group.title,value:item.title,tridx:tridx,tdidx:tdidx},...redata])}))}));return list};let totals=[],skus=[],list=getList(specs);for(let i=0;i<list.length;i++){const lis=list[i];skus[i]=[];for(let ii=0;ii<lis.length;ii++){const li=lis[ii];const total=totals[ii];skus[i].push(`${li.tridx}_${li.tdidx}`);if(total&&total.tdidx===li.tdidx&&lis.length!=ii+1&&(specs[li.tridx].list.length>1||0==ii)){totals[ii].rowspan++}else{if(total){list[total.i][total.ii].rowspan=total.rowspan}totals[ii]={value:li.value,tdidx:li.tdidx,rowspan:1,i:i,ii:ii}}}skus[i]=skus[i].join("-")}for(let i=0;i<totals.length;i++){const total=totals[i];list[total.i][total.ii].rowspan=total.rowspan}this.skus=skus;const{...datas}=this.specData.data;skus.forEach((sku=>{if(!datas[sku]){datas[sku]={}}}));this.specData.data=datas;this.tables=list;if(!first&&specs.length>1){let{...datas}=this.specData.data;Object.keys(datas).forEach((sku=>{datas[sku]={...datas[sku]};Object.keys(datas[sku]).forEach((key=>{datas[sku][key]=""}))}));this.specData.data=datas}}})}));