<template "ui/head" />
<template "ui/iframe" />
<template "ui/terminal" />
<style>#APPIFRAME{background:#303133}#LCONTENT{padding:0;height:100vh}</style>
<script type="text/javascript" onload>let tables=JSON.parse(`{{json_encode($tables)}}`),tblong=tables.length,tbindex=0;LCMS.util.tplx("terminal",{mounted(){this.$terminal=this.$store.terminal;layer.alert("确定开始备份数据？",{title:"提示",area:"120px",closeBtn:false},(layidx=>{layer.close(layidx);this.$terminal.addText({text:"即将开始数据备份",info:LCMS.util.getDate("Y-m-d H:i:s")});setTimeout((()=>{this.onExport()}),500)}))},onExport(){const table=tables[tbindex];this.$terminal.addText({text:`[${tbindex+1}/${tblong}] ${table}`,progress:true});this.onEach(table)},onEach(table,page){page=page||1;LCMS.util.ajax({type:"POST",url:`${LCMS.url.own_form}export`,data:{table:table,page:page},loading:false,success:res=>{if(1!=res.code){this.$terminal.addText({text:res.msg,info:LCMS.util.getDate("Y-m-d H:i:s")});return}const data=res.data;this.$terminal.setProgress(page/data.total*100);setTimeout((()=>{if(data.next>0){this.onEach(table,data.next);return}if(tbindex<tblong-1){tbindex++;this.onExport()}else{this.onDone()}}),500)}})},onDone(){this.$terminal.addText({text:"压缩备份数据",progress:true});LCMS.util.ajax({type:"GET",url:`${LCMS.url.own_form}index&action=backup-ok`,timeout:60*1000,success:res=>{this.$terminal.setProgress(100);this.$terminal.addText({text:res.msg,info:LCMS.util.getDate("Y-m-d H:i:s")})}})}});</script>
<template "ui/foot" />