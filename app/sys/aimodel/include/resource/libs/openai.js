LCMS.plugin.aimodel=Object.assign(LCMS.plugin.aimodel,{request:function(opts){if(!this.apicfg){return false}let data,messages=[],headers=new Headers({"Content-Type":"application/json",Authorization:"Bearer "+this.apicfg.token});if("api2d"==this.apicfg.type){headers.append("x-api2d-no-cache",1)}if(opts.system){messages.push({role:"system",content:opts.system})}messages=messages.concat(opts.messages);LCMS.util.EventSource(this.apicfg.api+"/v1/chat/completions",{method:"POST",headers:headers,body:JSON.stringify({model:this.apicfg.model,messages:messages,max_tokens:this.apicfg.max_tokens,temperature:0.9,stream:true}),redirect:"follow",onmessage:res=>{if("[DONE]"!=res.data){data=JSON.parse(res.data);if(data.choices){opts.onmessage&&opts.onmessage({content:data.choices[0].delta.content})}}},onclose:()=>{if("api2d"==this.apicfg.type){LCMS.util.ajax({type:"GET",url:`${this.apicfg.api}/dashboard/billing/credit_grants`,dataType:"json",timeout:60000,cache:true,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apicfg.token}`},success:function(res){opts.onclose&&opts.onclose({topinfo:`余额：${res.total_available}，有效期：${res.expire_at>0?LCMS.util.getDate("Y-m-d",new Date(res.expire_at)):0}，<a href="https://api2d.com/r/189177" target="_blank" style="color:#F56C6C">充值</a>`})},error:function(){LCMS.util.notify({type:"error",content:"TOEKN 错误"})}})}else{opts.onclose&&opts.onclose()}},onerror:error=>{opts.onerror&&opts.onerror(error);LCMS.util.notify({type:"error",content:error.message})}})}});