LCMS.util.load({type:"css",src:`${LCMS.url.public}ui/admin/static/editor.css`});let this_aimodel={};LCMS.util.tplx("aimodel",{chatOpts:parent.LCMS.plugin.aimodel.options,loading:`<i class="layui-icon layui-icon-loading-1 layui-anim layui-anim-rotate layui-anim-loop" style="margin-right:10px"></i>思考中`,chatIng:false,chatList:[],chatIndex:0,pluList:[],askText:"",topInfo:false,activeCount:0,init(){this_aimodel=this;if(this.chatOpts){this.chatOpts=Object.assign({ainame:"AI助手",welcome:"有什么可以帮助您的呢？"},this.chatOpts);this.reChat(true);if(this.chatOpts.content){this.chatFunc.chat(this.chatOpts.content)}if(this.chatOpts.plugins){const plus=[];for(let i=0;i<this.chatOpts.plugins.length;i++){const{...plu}=this.chatOpts.plugins[i];plus.push({title:plu.title,tips:plu.tips||"",onclick:plu.onclick||null})}this.pluList=plus}}},setScroll(){setTimeout((()=>{$(".aimodel-chat").scrollTop($(".aimodel-chat").prop("scrollHeight"))}))},setBtns(chatIndex,chatbtns){if(!this.chatList[chatIndex]){return}if(!chatbtns&&this.chatOpts&&this.chatOpts.chatbtns){chatbtns=this.chatOpts.chatbtns}const btns=[];if(chatbtns){for(let i=0;i<chatbtns.length;i++){const btn=chatbtns[i];btn.class=btn.class?` ${btn.class}`:"";btns.push({class:`layui-unselect${btn.class}`,title:btn.title,tips:btn.tips||"",onclick:btn.onclick||null})}}btns.push({class:"layui-icon layui-icon-file",title:"复制",tips:"点击复制回答内容",style:"color:#b1b3b8",onclick:(chatFunc,chat)=>{const text=chat.html.replace(/<[^>]*>/g,"").replace(/&(lt|gt|nbsp|amp|quot);/gi,(function(all,t){return{lt:"<",gt:">",nbsp:" ",amp:"&",quot:'"'}[t]})).replace(/^\r?\n|\r?\n$/g,"");LCMS.util.copy(text)}});this.chatList[chatIndex].btns=btns},reChat(type){this.activeCount=this.chatIndex;if(type){this.chatList=[];this.chatIndex=0;this.chatList.push({id:this.chatIndex,role:"assistant",name:this.chatOpts.ainame,html:this.chatOpts.welcome});this.setBtns(0)}},addChat(type,content=""){++this.chatIndex;switch(type){case"user":this.chatList.push({id:this.chatIndex,role:"user",name:"我",html:content});break;case"assistant":this.chatList.push({id:this.chatIndex,role:"assistant",name:this.chatOpts.ainame,content:content,html:content||this.loading,reasoning_content:""})}this.setScroll();return this.chatIndex},upChat(chatIndex,data){if(!this.chatList[chatIndex]){return}if(data.reasoning_content){this.chatList[chatIndex].reasoning_content+=data.reasoning_content}else if(this.chatList[chatIndex].html==this.loading){this.chatList[chatIndex].html=data.content}else{this.chatList[chatIndex].html+=data.content}},cvChat(chatIndex,data){if(!this.chatList[chatIndex]){return}this.chatList[chatIndex]=Object.assign(this.chatList[chatIndex],data)},clickChat(chatIndex,btn){btn.onclick&&btn.onclick(this.chatFunc,{id:chatIndex,content:this.chatList[chatIndex].content,html:this.chatList[chatIndex].html})},clickPlu(plu){plu.onclick&&plu.onclick(this.chatFunc,this.chatList)},chatFunc:{chat(text,chatbtns){if(!text){return}_this=this_aimodel;_this.addChat("user",text);_this.chatIng=true;setTimeout((()=>{const messages=[];for(let i=0;i<_this.chatList.length;i++){if(i<=_this.activeCount){continue}const{...chat}=_this.chatList[i];messages.push({role:chat.role,content:chat.html})}const chatIndex=_this.addChat("assistant");LCMS.plugin.aimodel.chat({system:_this.chatOpts.system,messages:messages,onmessage:res=>{if(res.reasoning_content){_this.upChat(chatIndex,{reasoning_content:res.reasoning_content})}if(res.content){if(-1!==res.content.indexOf("\n")){_this.cvChat(chatIndex,{html:res.html})}else{_this.upChat(chatIndex,{content:res.content})}}_this.setScroll()},onclose:function(res){_this.cvChat(chatIndex,{html:res.html,content:res.content,btns:true});_this.setBtns(chatIndex,chatbtns);_this.chatIng=false;_this.setScroll();if(res.topinfo){_this.topInfo=res.topinfo}},onerror:function(){_this.chatIng=false;setTimeout((()=>{_this.cvChat(chatIndex,{html:"⛔请求发生错误，请根据页面弹出的错误提示进行处理！"});_this.chatFunc.clear()}))}})}),500)},clear(type){_this=this_aimodel;_this.reChat(type)},input(text,clear){_this=this_aimodel;if(true==clear){_this.askText=text}else{let value=_this.askText;value=value?`${value}\n`:"";_this.askText=value+text}}},askGo(e){if(e.shiftKey){this.askText+="\n";return}if(this.chatIng){return}if(""==this.askText){LCMS.util.notify({type:"error",content:"请输入您的问题"});return}const text=this.askText;this.askText="";this.chatFunc.chat(text)},onHover(type,btn){switch(type){case"enter":if(this.hoverTimer){return}if(!btn.tips){return}layer.tips(btn.tips,this.$el,{tips:[1,"#303133"],time:0});break;case"leave":layer.closeAll("tips");break}}});