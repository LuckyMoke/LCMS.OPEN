LCMS.util.load({type:"css",src:`${LCMS.url.public}ui/admin/static/editor.css`});let tipsIndex,chatIndex=0,chatList=[],chatOn=false,chatBox=$(".aimodel-chat"),chatInput=$(".aimodel-input textarea"),chatButton=$(".aimodel-input button"),chatPlugin=$(".aimodel-plugins"),topInfo=$(".aimodel-top-info"),chatOpts=parent.LCMS.plugin.aimodel.options,answerElm=null,api2dBlance=function(){if(LCMS.plugin.aimodel.apicfg&&"api2d"==LCMS.plugin.aimodel.apicfg.type){LCMS.plugin.aimodel.api2d((function(res){topInfo.html(`余额：${res.total}，有效期：${res.expire}，<a href="https://api2d.com/r/189177" target="_blank" style="color:#F56C6C">充值</a>`).fadeIn()}))}},addChat=function(type,content){if(!content){return}chatList.push({role:type,content:content})},showChat=function(type,content){$(".layui-anim-upbit").removeClass("layui-anim-upbit");switch(type){case"user":addChat("user",content);chatBox.append(`<div class="layui-anim layui-anim-upbit aimodel-chat-right" index="${chatIndex}"><h3 class="layui-unselect aimodel-chat-name">我</h3><div class="aimodel-chat-body lcms-editor">${content}</div></div>`);break;case"assistant":chatBox.append(`<div class="layui-anim layui-anim-upbit aimodel-chat-left" index="${chatIndex}"><h3 class="layui-unselect aimodel-chat-name">AI助手</h3><div class="aimodel-chat-body lcms-editor"><i class="layui-icon layui-icon-loading-1 layui-anim layui-anim-rotate layui-anim-loop" style="margin-left:5px"></i></div></div>`);answerElm=$(`.aimodel-chat-left[index="${chatIndex}"] .aimodel-chat-body`);break}chatIndex++;chatBox.scrollTop($(".aimodel-chat").prop("scrollHeight"))},showChatbtns=function(opts){let chatbtns;if(opts.chatbtns||false===opts.chatbtns){chatbtns=opts.chatbtns}else if(chatOpts&&chatOpts.chatbtns){chatbtns=chatOpts.chatbtns}if(chatbtns){for(let i=0;i<chatbtns.length;i++){const button=chatbtns[i];button.tips=button.tips?button.tips:"";opts.elm.prepend(`<span class="layui-unselect tips" index="${i}" data-tips="${button.tips}">${button.title}</span>`)}}opts.elm.on("click",".tips",(function(){let index=$(this).attr("index");if(index){if("copydata"==index){let text=opts.html.replace(/<[^>]*>/g,"").replace(/&(lt|gt|nbsp|amp|quot);/gi,(function(all,t){return{lt:"<",gt:">",nbsp:" ",amp:"&",quot:'"'}[t]})).replace(/^\r?\n|\r?\n$/g,"");LCMS.util.copy(text)}else{chatbtns[index]&&chatbtns[index].onclick&&chatbtns[index].onclick(chatFunc,{content:opts.content,html:opts.html})}}}))},chatFunc={chat:function(content,chatbtns){if(!content){return}showChat("user",content);chatOn=true;setTimeout((()=>{showChat("assistant");LCMS.plugin.aimodel.chat({system:chatOpts.system,messages:chatList,onmessage:function(txt,html){if(-1!==txt.indexOf("\n")){answerElm.html(`${html}<i class="layui-icon layui-icon-loading-1 layui-anim layui-anim-rotate layui-anim-loop" style="margin-left:5px"></i>`)}else{answerElm.children("i.layui-icon").before(txt)}chatBox.scrollTop($(".aimodel-chat").prop("scrollHeight"))},onclose:function(content,html){addChat("assistant",content);answerElm.html(`${html}<div class="aimodel-chatbtns"><span class="layui-icon layui-icon-file tips" index="copydata" data-tips="复制内容到剪贴板" style="color:#b1b3b8">复制</span></div>`);showChatbtns({elm:answerElm.children(".aimodel-chatbtns"),content:content,html:html,chatbtns:chatbtns||false===chatbtns?chatbtns:null});chatOn=false;chatBox.scrollTop($(".aimodel-chat").prop("scrollHeight"));api2dBlance()},onerror:function(){chatOn=false}})}),500)},clear:function(type){chatList=[];type&&chatBox.html(`<div class="layui-anim layui-anim-upbit aimodel-chat-left"><h3 class="layui-unselect aimodel-chat-name">AI助手</h3><div class="aimodel-chat-body lcms-editor">有什么可以帮助您的呢？</div></div>`)}};if(chatOpts){chatOpts.content&&chatFunc.chat(chatOpts.content);if("openai"==chatOpts.model){LCMS.plugin.aimodel.chat();api2dBlance()}if(chatOpts.plugins){for(let i=0;i<chatOpts.plugins.length;i++){const plugin=chatOpts.plugins[i];plugin.tips=plugin.tips?plugin.tips:"";chatPlugin.append(`<span class="layui-unselect tips" index="${i}" data-tips="${plugin.tips}">${plugin.title}</span>`)}chatPlugin.fadeIn();chatPlugin.on("click",".tips",(function(){let index=$(this).attr("index");if(index&&chatOpts.plugins[index]){chatOpts.plugins[index].onclick&&chatOpts.plugins[index].onclick(chatFunc,chatList)}}))}}chatButton.on("click",(function(){if(chatOn){return}let content=chatInput.val();if(""==content){LCMS.util.notify({type:"error",content:"请输入您的问题"});return}chatInput.val("");chatFunc.chat(content)}));chatInput[0].addEventListener("keydown",(function(event){if("Enter"===event.key&&!event.shiftKey){event.preventDefault();chatButton.click()}}));$(".aimodel").on("mouseenter mouseleave",".tips",(function(e){let text=$(this).attr("data-tips");switch(e.type){case"mouseenter":if(text){tipsIndex=layer.tips(text,$(this),{tips:[1,"#303133"],time:0})}break;case"mouseleave":tipsIndex&&layer.close(tipsIndex);break}}));