if($(".app-local").length>0){LCMS.util.lazyImg();let setUrl=function(url){if(self==parent){location.href=url}else{parent.history.pushState(null,null,"?"+$.base64.encode(url.match(/\?(.*)/)[0]));parent.LBOX.attr("src",url)}};$(".app-local .li>a").on("click",function(){setUrl($(this).attr("href"));return false});$(".app-local .li").on({mouseenter:function(){var tips=$(this).attr("data-description");tips&&layer.tips(tips,this,{tips:[1,"#303133"],time:0})},mouseleave:function(){layer.closeAll("tips")},});$(".app-repair").on("click",function(){var url=$(this).attr("data-url");layer.alert("我已做好数据备份，立即进行数据表修复。",{title:"提示"},function(index){layer.close(index);LCMS.util.ajax({type:"GET",url:url,loading:true,timeout:0,success:function(res){if(res.code==1){LCMS.util.notify({content:res.msg})}else{LCMS.util.notify({type:"error",content:res.msg})}},})})});$(".app-uninstall").on("click",function(){var url=$(this).attr("data-url");LCMS.util.notify({type:"flash"});layer.alert('<span style="color:red">卸载应用会删除应用文件和数据，请先做好备份！</span>',{title:"提示"},function(index){layer.close(index);LCMS.util.ajax({type:"GET",url:url,loading:true,timeout:0,success:function(res){if(res.code==1){LCMS.util.notify({content:res.msg});setTimeout(function(){window.location.reload()},1000)}else{LCMS.util.notify({type:"error",content:res.msg})}},})})});if($(".app-update-btn").length>0){var applist=[],appli=$(".app-local .li"),now=Math.round(new Date().getTime()/1000),cache=layui.data("LCMS_cache",{key:"appstore_check_all"}),showBtn=function(data){appli.each(function(){var app=$(this).data();if(data[app.name]&&data[app.name].ver>app.ver){$(this).addClass("active").find(".layui-btn-disabled").removeClass("layui-btn-disabled").addClass("app-update").attr("data-lver",app.ver).attr("data-nver",data[app.name].ver).attr("data-id",data[app.name].id)}})};cache=cache||{};appli.each(function(index){var data=$(this).data();applist[index]={name:data.name,ver:data.ver}});if(applist.length>0){if(cache.expired>=now){showBtn(cache.data)}else{LCMS.util.ajax({type:"POST",url:LCMS.url.own_form+"check&c=store",data:{applist:JSON.stringify(applist)},success:function(res){if(res.code==1){layui.data("LCMS_cache",{key:"appstore_check_home",value:{data:res.data,expired:now+43200}});layui.data("LCMS_cache",{key:"appstore_check_all",value:{data:res.data,expired:now+43200}});showBtn(res.data)}},})}}appli.on("click",".app-update",function(){var app=$(this).data();LCMS.util.iframe({title:"立即更新",url:LCMS.url.own_form+"check&c=store&action=content&type=up&id="+app.id+"&localver="+app.lver+"&appver="+app.nver})})}Sortable.create($(".app-local")[0],{handle:".move",onEnd:function(){$(".submit").click()},});$(".app-local .move").length>0&&LCMS.util.setMenu([{title:"设置默认应用",icon:"component",bgcolor:"#E6A23C",color:"",url:function(){LCMS.util.iframe({title:"设置默认应用",url:LCMS.url.own_form+"setdefault",area:["500px","500px"]})},},])}if($(".install-progress").length>0){var api=LCMS.url.own_form,appinfo=$(".install-progress").data(),tips=$(".install-tips"),install=function(){tips.html("正在解压安装文件 请勿进行其它操作");LCMS.util.ajax({type:"POST",url:api+"install",data:{action:"copy_files",appid:appinfo.id,appname:appinfo.name,appver:appinfo.ver},success:function(res){if(res.code==1){layui.data("LCMS_cache",{key:"appstore_check_home",remove:true});layui.data("LCMS_cache",{key:"appstore_check_all",remove:true});layui.element.progress("download","90%");tips.html("正在安装应用数据 请勿进行其它操作");LCMS.util.ajax({type:"POST",url:api+"&n=backup&c=repair",data:{apptitle:"安装",appname:appinfo.name},timeout:10000,complete:function(){layui.element.progress("download","95%");LCMS.util.ajax({type:"POST",url:api+"install",data:{action:"get_oauth",appid:appinfo.id,appname:appinfo.name,appver:appinfo.ver,type:$(".install-progress").attr("data-type")},success:function(res){if(res.code==1){layui.element.progress("download","100%");tips.html("安装成功 页面即将刷新");setTimeout(function(){parent.layer.closeAll();if("LBOX"==window.parent.frameElement.getAttribute("id")){parent.location.href="index.php?t=sys&n=appstore&c=local&a=&retime="+new Date().getTime()}else{window.location.reload()}},2000)}else{tips.html(res.msg)}},})},})}else{tips.html(res.msg)}},})},download=function(){var timer;$.ajax({url:api+"install&action=down_file&appid="+appinfo.id+"&file="+appinfo.file,dataType:"json",cache:false,timeout:120000,success:function(res){install()},error:function(){tips.html("数据加载失败！");LCMS.util.notify({type:"error",content:"数据加载失败"})},complete:function(){clearInterval(timer)},});timer=setInterval(()=>{LCMS.util.ajax({type:"GET",url:api+"install&action=get_size&appid="+appinfo.id,success:function(res){if(res.code==1){layui.element.progress("download",Math.floor((res.data/appinfo.size)*90)+"%")}},})},1000)};tips.html("正在获取需应用信息");LCMS.util.ajax({type:"POST",url:api+"install",data:{action:"get_info",appid:appinfo.id,appver:appinfo.ver},success:function(res){if(res.code==1){appinfo=res.data;if(appinfo.file&&appinfo.size>"0.00"){tips.html("正在下载文件 请勿进行其它操作");download()}else{LCMS.util.notify({type:"error",content:"安装失败"})}}else{LCMS.util.notify({type:"error",content:res.msg})}},})}